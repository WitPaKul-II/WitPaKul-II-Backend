default:
  image:
    name: docker/compose:latest
    entrypoint: ["/bin/sh", "-c"]
  tags:
    - "backend"

variables:
  CI_DOCKER_REPO: $CI_REGISTRY/witpakul/witpakul-ii-backend

stages:
  - build docker image
  - push docker image
  - pull docker image
  - deploy docker container
  - prepare
  - release


build image:
  stage: build docker image
  script:
    - docker build -t $CI_DOCKER_REPO:latest -f Dockerfile .
  when: on_success

before_script:
  - docker info
  - docker version
  - docker-compose version
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

push docker image:
  stage: push docker image
  script:
    - docker push $CI_DOCKER_REPO:latest

pull image:    
  stage: pull docker image
  script:
    - docker-compose down
    - docker rmi $(docker images | grep "<none>" | awk '{print $3}')
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $CI_DOCKER_REPO:latest

deploy container:
  stage: deploy docker container
  script:
    - docker-compose up -d

generate_tag:
  stage: prepare
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANC
  script:
    - echo "TAG=$(cat VERSION)" > tag.env
  artifacts:
    reports:
      dotenv: tag.env

auto-release-master:
  image: registry.gitlab.com/gitlab-org/release-cli
  needs:
    - job: generate_tag
      artifacts: true
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
      when: never                                
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH 
  script:
    - echo "Release $TAG"
  release:
    name: "Release $TAG"
    description: "Created using the release-cli $EXTRA_DESCRIPTION"
    tag_name: v$TAG
    ref: $CI_COMMIT_SHA
    milestones:
      - 'm2'



# release_job:
#   stage: release
#   image: registry.gitlab.com/gitlab-org/release-cli:latest
#   rules:
#     - if: $CI_COMMIT_TAG
#   script:
#     - echo 'running release_job'

#   release:
#    name: 'Release $CI_COMMIT_TAG'
#    description: 'Created using the release-cli $EXTRA_DESCRIPTION'
#    tag_name: '$CI_COMMIT_TAG'
#    milestones:
#       - 'm1'
#       - 'm2'
#       - 'm3'

  # only:
  #   refs:
  #     - master
  #     - develop
